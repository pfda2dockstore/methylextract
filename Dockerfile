# Generated by precisionFDA exporter (v1.0.3) on 2018-06-14 03:33:19 +0000
# The asset download links in this file are valid only for 24h.

# Exported app: methylextract, revision: 1, authored by: ricardo.lebron
# https://precision.fda.gov/apps/app-F0VVJB800QKpxQbF196Kjv47

# For more information please consult the app export section in the precisionFDA docs

# Start with Ubuntu 14.04 base image
FROM ubuntu:14.04

# Install default precisionFDA Ubuntu packages
RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
	aria2 \
	byobu \
	cmake \
	cpanminus \
	curl \
	dstat \
	g++ \
	git \
	htop \
	libboost-all-dev \
	libcurl4-openssl-dev \
	libncurses5-dev \
	make \
	perl \
	pypy \
	python-dev \
	python-pip \
	r-base \
	ruby1.9.3 \
	wget \
	xz-utils

# Install default precisionFDA python packages
RUN pip install \
	requests==2.5.0 \
	futures==2.2.0 \
	setuptools==10.2

# Add DNAnexus repo to apt-get
RUN /bin/bash -c "echo 'deb http://dnanexus-apt-prod.s3.amazonaws.com/ubuntu trusty/amd64/' > /etc/apt/sources.list.d/dnanexus.list"
RUN /bin/bash -c "echo 'deb http://dnanexus-apt-prod.s3.amazonaws.com/ubuntu trusty/all/' >> /etc/apt/sources.list.d/dnanexus.list"
RUN curl https://wiki.dnanexus.com/images/files/ubuntu-signing-key.gpg | apt-key add -

# Install app-specific Ubuntu packages
RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
	gzip \
	perl \
	samtools \
	tar

# Download app assets
RUN curl https://dl.dnanex.us/F/D/P0897gvxGQbpqK1Kqypv57qG2Kjk41Vgf42F205P/MethylExtract.tar.gz | tar xzf - -C / --no-same-owner --no-same-permissions

# Download helper executables
RUN curl https://dl.dnanex.us/F/D/0K8P4zZvjq9vQ6qV0b6QqY1z2zvfZ0QKQP4gjBXp/emit-1.0.tar.gz | tar xzf - -C /usr/bin/ --no-same-owner --no-same-permissions
RUN curl https://dl.dnanex.us/F/D/bByKQvv1F7BFP3xXPgYXZPZjkXj9V684VPz8gb7p/run-1.2.tar.gz | tar xzf - -C /usr/bin/ --no-same-owner --no-same-permissions

# Write app spec and code to root folder
RUN ["/bin/bash","-c","echo -E \\{\\\"spec\\\":\\{\\\"input_spec\\\":\\[\\{\\\"name\\\":\\\"seq\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Reference\\ Genome\\ Sequences\\\",\\\"help\\\":\\\"Reference\\ genome\\ sequences\\ multiFASTA\\ file\\\",\\\"default\\\":\\\"file-F0QzjJj0ZpYj511V4Vx9px3B\\\"\\},\\{\\\"name\\\":\\\"inFile\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"SAM/BAM\\ Input\\ File\\\",\\\"help\\\":\\\"Input\\ alignments\\ in\\ SAM/BAM\\ format\\ \\(\\)\\\",\\\"default\\\":\\\"file-F0QzfpQ0ZpYfZj590J8Z01x8\\\"\\},\\{\\\"name\\\":\\\"outName\\\",\\\"class\\\":\\\"string\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Basename\\ of\\ Output\\ File\\\",\\\"help\\\":\\\"Basename\\ of\\ output\\ file\\\",\\\"default\\\":\\\"MethylExtract_outFile\\\"\\},\\{\\\"name\\\":\\\"bedOut\\\",\\\"class\\\":\\\"boolean\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Output\\ in\\ BED\\ Format\\\",\\\"help\\\":\\\"Extract\\ methylation\\ values\\ in\\ BED\\ format\\\",\\\"default\\\":false\\},\\{\\\"name\\\":\\\"wigOut\\\",\\\"class\\\":\\\"boolean\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Output\\ in\\ WIG\\ Format\\\",\\\"help\\\":\\\"Extract\\ methylation\\ values\\ in\\ WIG\\ format\\\",\\\"default\\\":false\\},\\{\\\"name\\\":\\\"context\\\",\\\"class\\\":\\\"string\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Methylation\\ Context\\(s\\)\\\",\\\"help\\\":\\\"Methylation\\ context\\(s\\)\\ used\\ for\\ profiling\\\",\\\"default\\\":\\\"CG\\\",\\\"choices\\\":\\[\\\"CG\\\",\\\"CHG\\\",\\\"CHH\\\",\\\"ALL\\\"\\]\\},\\{\\\"name\\\":\\\"flagW\\\",\\\"class\\\":\\\"string\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Flag\\(s\\)\\ of\\ Reads\\ Mapped\\ on\\ Watson\\ Strand\\\",\\\"help\\\":\\\"Used\\ flag\\(s\\)\\ in\\ the\\ SAM/BAM\\ file\\ for\\ reads\\ mapped\\ on\\ Watson\\ strand\\ \\(by\\ default:\\ 0\\ for\\ single-end\\ alignments\\;\\ 99,147\\ for\\ paired-end\\ alignments\\)\\\",\\\"default\\\":\\\"0,99,147\\\"\\},\\{\\\"name\\\":\\\"flagC\\\",\\\"class\\\":\\\"string\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Flag\\(s\\)\\ of\\ Reads\\ Mapped\\ on\\ Crick\\ Strand\\\",\\\"help\\\":\\\"Used\\ flag\\(s\\)\\ in\\ the\\ SAM/BAM\\ file\\ for\\ reads\\ mapped\\ on\\ Crick\\ strand\\ \\(by\\ default:\\ 16\\ for\\ single-end\\ alignments\\;\\ 83,163\\ for\\ paired-end\\ alignments\\)\\\",\\\"default\\\":\\\"16,83,163\\\"\\},\\{\\\"name\\\":\\\"qscore\\\",\\\"class\\\":\\\"string\\\",\\\"optional\\\":false,\\\"label\\\":\\\"PHRED\\ Score\\ Encoding\\\",\\\"help\\\":\\\"PHRED\\ score\\ encoding\\ used\\ in\\ the\\ SAM/BAM\\ file\\\",\\\"default\\\":\\\"phred33-quals\\\",\\\"choices\\\":\\[\\\"phred33-quals\\\",\\\"phred64-quals\\\",\\\"solexaquals\\\",\\\"solexa1.3-quals\\\"\\]\\},\\{\\\"name\\\":\\\"minQ\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Minimum\\ Quality\\ Value\\ for\\ Profiling\\\",\\\"help\\\":\\\"Minimum\\ PHRED\\ quality\\ value\\ required\\ for\\ methylation\\ and\\ SNV\\ profiling\\\",\\\"default\\\":20\\},\\{\\\"name\\\":\\\"minDepthMeth\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Minimum\\ Coverage\\ to\\ Report\\ Methylation\\\",\\\"help\\\":\\\"Minimum\\ coverage\\ in\\ order\\ to\\ report\\ the\\ methylation\\ value\\ of\\ the\\ position\\\",\\\"default\\\":1\\},\\{\\\"name\\\":\\\"methNonCpGs\\\",\\\"class\\\":\\\"float\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Maximum\\ Fraction\\ of\\ methylated\\ non-CpG\\\",\\\"help\\\":\\\"Maximum\\ fraction\\ of\\ methylated\\ non-CpG\\ \\(to\\ avoid\\ putative\\ bisulfite\\ failures\\)\\\",\\\"default\\\":0.9\\},\\{\\\"name\\\":\\\"minDepthSNV\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Minimum\\ Coverage\\ to\\ Check\\ for\\ Variation\\\",\\\"help\\\":\\\"Minimum\\ coverage\\ in\\ order\\ to\\ check\\ a\\ position\\ for\\ variation\\\",\\\"default\\\":1\\},\\{\\\"name\\\":\\\"varFraction\\\",\\\"class\\\":\\\"float\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Minimum\\ Frequency\\ of\\ a\\ Variant\\\",\\\"help\\\":\\\"Minimum\\ frequency\\ of\\ a\\ variant\\ to\\ be\\ considered\\ \\\",\\\"default\\\":0.1\\},\\{\\\"name\\\":\\\"maxPval\\\",\\\"class\\\":\\\"float\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Maximum\\ p-Value\\ for\\ SNV\\ Profiling\\\",\\\"help\\\":\\\"Maximum\\ Fisher\\’s\\ exact\\ test\\ p-value\\ for\\ SNV\\ profiling\\\",\\\"default\\\":0.05\\},\\{\\\"name\\\":\\\"maxStrandBias\\\",\\\"class\\\":\\\"float\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Maximum\\ Strand\\ Bias\\ Allowed\\\",\\\"help\\\":\\\"Maximum\\ strand\\ bias\\ allowed\\ for\\ SNV\\ profiling\\\",\\\"default\\\":0.7\\},\\{\\\"name\\\":\\\"delDup\\\",\\\"class\\\":\\\"boolean\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Delete\\ Duplicated\\ Reads\\\",\\\"help\\\":\\\"Delete\\ duplicated\\ reads\\ \\(this\\ step\\ is\\ not\\ advised\\ for\\ RRBS\\ methodology\\)\\\",\\\"default\\\":false\\},\\{\\\"name\\\":\\\"simDupPb\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Number\\ of\\ Equal\\ Nucleotides\\ in\\ Putatively\\ Duplicated\\ Reads\\\",\\\"help\\\":\\\"Number\\ of\\ equal\\ nucleotides\\ at\\ the\\ 5\\’\\ end\\ of\\ the\\ reads,\\ that\\ map\\ to\\ the\\ same\\ position,\\ in\\ order\\ to\\ consider\\ them\\ putatively\\ duplicated\\ reads\\\",\\\"default\\\":32\\},\\{\\\"name\\\":\\\"peOverlap\\\",\\\"class\\\":\\\"boolean\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Discard\\ the\\ Second\\ Mate\\ Overlapping\\ Segment\\\",\\\"help\\\":\\\"Discard\\ the\\ second\\ mate\\ overlapping\\ segment\\ on\\ paired-end\\ alignment\\ reads\\\",\\\"default\\\":false\\},\\{\\\"name\\\":\\\"FirstIgnor\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Number\\ of\\ First\\ Bases\\ to\\ be\\ Ignored\\\",\\\"help\\\":\\\"Number\\ of\\ bases\\ to\\ be\\ ignored\\ at\\ the\\ 5\\’\\ end\\ of\\ the\\ reads\\\",\\\"default\\\":0\\},\\{\\\"name\\\":\\\"LastIgnor\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Number\\ of\\ Last\\ Bases\\ to\\ be\\ Ignored\\\",\\\"help\\\":\\\"Number\\ of\\ bases\\ to\\ be\\ ignored\\ at\\ the\\ 3\\’\\ end\\ of\\ the\\ reads\\\",\\\"default\\\":0\\},\\{\\\"name\\\":\\\"p\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Number\\ of\\ Threads\\\",\\\"help\\\":\\\"Number\\ of\\ threads\\ to\\ parallelize\\ the\\ process\\\",\\\"default\\\":32\\},\\{\\\"name\\\":\\\"chromDiv\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Number\\ of\\ Divisions\\ per\\ Chromosome\\\",\\\"help\\\":\\\"Number\\ of\\ divisions\\ per\\ chromosome\\ to\\ sort\\ the\\ reads\\\",\\\"default\\\":400\\},\\{\\\"name\\\":\\\"memNumReads\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Number\\ of\\ Reads\\ Kept\\ in\\ Memory\\\",\\\"help\\\":\\\"Number\\ of\\ reads\\ kept\\ in\\ memory\\ during\\ sorting\\ and\\ profiling\\ steps\\\",\\\"default\\\":1000000\\}\\],\\\"output_spec\\\":\\[\\{\\\"name\\\":\\\"outFile\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"Output\\ File\\\",\\\"help\\\":\\\"Output\\ compressed\\ folder\\ \\(tar.gz\\)\\\"\\}\\],\\\"internet_access\\\":false,\\\"instance_type\\\":\\\"himem-32\\\"\\},\\\"assets\\\":\\[\\\"file-F0VK0qQ0ZpYZ3kz0bQZkp32Z\\\"\\],\\\"packages\\\":\\[\\\"gzip\\\",\\\"perl\\\",\\\"samtools\\\",\\\"tar\\\"\\]\\} \u003e /spec.json"]
RUN ["/bin/bash","-c","echo -E \\{\\\"code\\\":\\\"tmpDir\\=/work/tmp/\\$inFile_prefix\\\\noutDir\\=/work/out\\\\n\\\\nmkdir\\ -p\\ \\$tmpDir\\ \\$outDir\\ \\\\u0026\\\\u0026\\ mv\\ \\$inFile_path\\ \\$tmpDir/\\\\n\\\\nif\\ \\[\\ \\$delDup\\ \\=\\ \\\\\\\"true\\\\\\\"\\ \\]\\\\nthen\\\\n\\\\tdelDup\\=Y\\\\nelse\\\\n\\\\tdelDup\\=N\\\\nfi\\\\n\\\\nif\\ \\[\\ \\$peOverlap\\ \\=\\ \\\\\\\"true\\\\\\\"\\ \\]\\\\nthen\\\\n\\\\tpeOverlap\\=Y\\\\nelse\\\\n\\\\tpeOverlap\\=N\\\\nfi\\\\n\\\\nif\\ \\[\\ \\$bedOut\\ \\=\\ \\\\\\\"true\\\\\\\"\\ \\]\\\\nthen\\\\n\\\\tbedOut\\=Y\\\\nelse\\\\n\\\\tbedOut\\=N\\\\nfi\\\\n\\\\nif\\ \\[\\ \\$wigOut\\ \\=\\ \\\\\\\"true\\\\\\\"\\ \\]\\\\nthen\\\\n\\\\twigOut\\=Y\\\\nelse\\\\n\\\\twigOut\\=N\\\\nfi\\\\n\\\\nMethylExtract\\ seq\\=\\$seq_path\\ inDir\\=\\$tmpDir\\ flagW\\=\\$flagW\\ flagC\\=\\$flagC\\ qscore\\=\\$qscore\\ delDup\\=\\$delDup\\ peOverlap\\=\\$peOverlap\\ simDupPb\\=\\$simDupPb\\ FirstIgnor\\=\\$FirstIgnor\\ LastIgnor\\=\\$LastIgnor\\ minDepthMeth\\=\\$minDepthMeth\\ minDepthSNV\\=\\$minDepthSNV\\ minQ\\=\\$minQ\\ methNonCpGs\\=\\$methNonCpGs\\ varFraction\\=\\$varFraction\\ maxPval\\=\\$maxPval\\ maxStrandBias\\=\\$maxStrandBias\\ p\\=\\$p\\ chromDiv\\=\\$chromDiv\\ memNumReads\\=\\$memNumReads\\ context\\=\\$context\\ bedOut\\=\\$bedOut\\ wigOut\\=\\$wigOut\\ outDir\\=\\$outDir\\\\n\\\\ncd\\ \\$outDir\\ \\\\u0026\\\\u0026\\ tar\\ -pczvf\\ /work/\\$outName.tar.gz\\ \\*\\\\n\\\\nemit\\ outFile\\ /work/\\$outName.tar.gz\\\"\\} | python -c 'import sys,json; print json.load(sys.stdin)[\"code\"]' \u003e /script.sh"]

# Create directory /work and set it to $HOME and CWD
RUN mkdir -p /work
ENV HOME="/work"
WORKDIR /work

# Set entry point to container
ENTRYPOINT ["/usr/bin/run"]

VOLUME /data
VOLUME /work